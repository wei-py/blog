Q: é‚£æˆ‘è¿˜æœ‰äºŒæ¬¡å°è£…ä¸€ä¸‹fetchæ¥ä½¿ç”¨ï¼Œè¿™æ ·ç»“åˆnextçš„ä¼˜åŠ¿

éå¸¸å¥½çš„é—®é¢˜ï¼ğŸ‘

ä½ é—®çš„æ˜¯ï¼š**â€œæˆ‘æ˜¯å¦åº”è¯¥å¯¹ `fetch` è¿›è¡ŒäºŒæ¬¡å°è£…ï¼Œæ¥æ›´å¥½åœ°ç»“åˆ Next.js çš„ä¼˜åŠ¿ï¼Ÿâ€**

### âœ… ç®€çŸ­å›ç­”ï¼š

> **å¯ä»¥å°è£…ï¼Œä½†è¦â€œæ™ºèƒ½å°è£…â€â€”â€”ä¸è¦ç ´å Next.js å¯¹ `fetch` çš„åŸç”Ÿå¢å¼ºï¼ˆå¦‚ç¼“å­˜ã€revalidateã€æµå¼æ¸²æŸ“ï¼‰**ã€‚

---

## ğŸ§© ä¸€ã€Next.js å¯¹ `fetch` çš„å¢å¼ºï¼ˆä¸èƒ½ä¸¢ï¼‰

Next.js åœ¨æœåŠ¡ç«¯ï¼ˆServer Componentsï¼‰ä¸­å¯¹åŸç”Ÿ `fetch` åšäº†å…³é”®å¢å¼ºï¼š

| ç‰¹æ€§                  | è¯´æ˜                             |
| --------------------- | -------------------------------- |
| âœ… è‡ªåŠ¨ç¼“å­˜           | ç›¸åŒ URL çš„ `fetch` è‡ªåŠ¨å»é‡     |
| âœ… æ”¯æŒ `revalidate`  | å®ç° ISRï¼ˆå¢é‡é™æ€å†ç”Ÿï¼‰         |
| âœ… ä¸ `Suspense` é…åˆ | æ”¯æŒæµå¼æ¸²æŸ“ï¼ˆStreamingï¼‰        |
| âœ… è·¨ç»„ä»¶è¯·æ±‚å»é‡     | å¤šä¸ªç»„ä»¶è¯·æ±‚åŒä¸€èµ„æºï¼Œåªæ‰§è¡Œä¸€æ¬¡ |

> âš ï¸ å¦‚æœä½ â€œç²—æš´å°è£…â€ï¼ˆæ¯”å¦‚ç”¨ axios æˆ–è‡ªå®šä¹‰æ‹¦æˆªå™¨ï¼‰ï¼Œå¯èƒ½ä¼š**ä¸¢å¤±è¿™äº›èƒ½åŠ›**ã€‚

---

## âœ… äºŒã€å¯ä»¥å°è£…çš„å†…å®¹ï¼ˆæ¨èåšæ³•ï¼‰

ä½ å¯ä»¥å°è£… **é€šç”¨é€»è¾‘**ï¼Œä½†è¦**ä¿ç•™åŸç”Ÿ `fetch` çš„è°ƒç”¨**ï¼Œå¹¶æ”¯æŒ Next.js ç‰¹æ€§ã€‚

### âœ… æ¨èå°è£…ç‚¹ï¼š

#### 1. **ç»Ÿä¸€è¯·æ±‚é…ç½®ï¼ˆåŸºç¡€å°è£…ï¼‰**

```ts
// lib/api.ts
async function baseFetch(url: string, options: RequestInit = {}) {
  const defaultHeaders = {
    'Content-Type': 'application/json',
    ...options.headers,
  };

  // æ·»åŠ è®¤è¯ token
  const token = await getAuthToken();
  if (token) {
    defaultHeaders['Authorization'] = `Bearer ${token}`;
  }

  return fetch(url, {
    ...options,
    headers: defaultHeaders,
  });
}

export const api = {
  get: (url: string, options?: RequestInit) =>
    baseFetch(url, { ...options, method: 'GET' }),

  post: (url: string, body: any, options?: RequestInit) =>
    baseFetch(url, { ...options, method: 'POST', body: JSON.stringify(body) }),

  // å…¶ä»–æ–¹æ³•...
};
```

ä½¿ç”¨ï¼š

```ts
// app/page.tsx
const res = await api.get('/api/users', {
  next: { revalidate: 60, tags: ['users'] } // âœ… ä¿ç•™ Next.js ç‰¹æ€§
});
```

âœ… ä¼˜åŠ¿ï¼š

- ç»Ÿä¸€ headerã€è®¤è¯
- ä¿ç•™ `next.revalidate`ã€`tags` ç­‰ç‰¹æ€§
- ä¸ç ´ååŸç”Ÿ `fetch` è¡Œä¸º

---

#### 2. **é”™è¯¯å¤„ç†å°è£…**

```ts
async function handleResponse(res: Response) {
  if (!res.ok) {
    const error = new Error(`HTTP ${res.status}: ${res.statusText}`);
    error.name = 'ApiError';
    throw error;
  }
  return res.json();
}

// ä½¿ç”¨
const res = await baseFetch('/api/users');
const data = await handleResponse(res);
```

---

#### 3. **ç±»å‹å®‰å…¨å°è£…ï¼ˆé…åˆ TypeScriptï¼‰**

```ts
type ApiResponse<T> = { data: T; error?: string };

async function fetchJson<T>(url: string, options?: RequestInit): Promise<T> {
  const res = await fetch(url, options);
  if (!res.ok) throw new Error(await res.text());
  return res.json();
}

// ä½¿ç”¨æ³›å‹
const users = await fetchJson<User[]>('/api/users', {
  next: { revalidate: 60 }
});
```

---

#### 4. **ç¼“å­˜æ ‡ç­¾è‡ªåŠ¨ç®¡ç†ï¼ˆé«˜çº§ï¼‰**

```ts
const API_TAGS = {
  users: 'users',
  posts: 'posts',
  profile: 'profile',
};

export async function fetchWithTags<T>(
  url: string,
  tags: string[],
  options?: RequestInit
): Promise<T> {
  return fetch(url, {
    ...options,
    next: {
      revalidate: 60,
      tags: tags,
      ...options.next,
    },
  }).then(r => r.json());
}

// ä½¿ç”¨
const users = await fetchWithTags<User[]>('/api/users', ['users']);
```

è¿™æ ·ä½ å¯ä»¥ç”¨ `revalidateTag('users')` æ‰¹é‡åˆ·æ–°ã€‚

---

## âŒ ä¸‰ã€ä¸è¦åšçš„å°è£…ï¼ˆé¿å…ç ´å Next.js ä¼˜åŠ¿ï¼‰

| é”™è¯¯åšæ³•                            | é—®é¢˜                                  |
| ----------------------------------- | ------------------------------------- |
| ç”¨ `axios` æ›¿ä»£ `fetch`             | âŒ ä¸¢å¤±è‡ªåŠ¨ç¼“å­˜ã€revalidateã€æµå¼æ¸²æŸ“ |
| å°è£…æˆ class å¹¶éšè— `fetch` è°ƒç”¨    | âŒ å¯èƒ½ç ´åè¯·æ±‚å»é‡                   |
| åœ¨å®¢æˆ·ç«¯ç»„ä»¶ä¸­é¢‘ç¹ `fetch` åŒä¸€èµ„æº | âŒ æœåŠ¡ç«¯ç»„ä»¶ä¸­æ›´å¥½                   |

> âš ï¸ å¦‚æœä½ å¿…é¡»ç”¨ `axios`ï¼Œè¯·åªåœ¨ **å®¢æˆ·ç«¯ç»„ä»¶** ä¸­ä½¿ç”¨ï¼Œå¹¶åœ¨ **æœåŠ¡ç«¯ç»„ä»¶ä¸­åšæŒç”¨ `fetch`**ã€‚

---

## âœ… å››ã€æœ€ä½³å®è·µï¼šåˆ†å±‚å°è£…ç­–ç•¥

```ts
// 1. åº•å±‚ï¼šåŸç”Ÿ fetch + å¢å¼º
// lib/fetch.ts
export function $fetch(url: string, options?: RequestInit) {
  return fetch(url, {
    headers: { 'X-App-Version': '1.0' },
    ...options,
  });
}

// 2. ä¸­å±‚ï¼šä¸šåŠ¡ API å°è£…
// lib/api/users.ts
export const UserApi = {
  list: () => $fetch('/api/users', { next: { revalidate: 60, tags: ['users'] } }),
  get: (id: string) => $fetch(`/api/users/${id}`),
};

// 3. ä¸Šå±‚ï¼šé¡µé¢ä¸­ä½¿ç”¨
// app/users/page.tsx
export default async function UsersPage() {
  const users = await UserApi.list();
  return <UserList users={users} />;
}
```

âœ… ä¼˜åŠ¿ï¼š

- ä¿æŒ `fetch` åŸç”Ÿè°ƒç”¨
- æ”¯æŒ `next.revalidate` å’Œ `tags`
- ç±»å‹å®‰å…¨ã€æ˜“äºç»´æŠ¤

---

## ğŸ¯ äº”ã€ç»“åˆ Server Actions çš„ç»ˆææ¨¡å¼

ä½ ç”šè‡³å¯ä»¥æŠŠ API è°ƒç”¨å°è£…åœ¨ Server Actions ä¸­ï¼š

```ts
// app/actions/user.ts
'use server';
import { $fetch } from '@/lib/fetch';

export async function getUsers() {
  return $fetch('/api/legacy-system/users', {
    next: { revalidate: 60, tags: ['users'] }
  });
}
```

```tsx
// app/users/page.tsx
export default async function Users() {
  const users = await getUsers();
  return <div>{/* æ¸²æŸ“ */}</div>;
}
```

âœ… å®Œç¾ç»“åˆï¼š

- å°è£…äº† API è°ƒç”¨
- ä¿ç•™äº† Next.js ç¼“å­˜
- å®‰å…¨ï¼ˆæœåŠ¡ç«¯æ‰§è¡Œï¼‰
- æ”¯æŒ revalidate/tag

---

## âœ… æ€»ç»“ï¼šå¦‚ä½•æ­£ç¡®äºŒæ¬¡å°è£… `fetch`

| åŸåˆ™                 | åšæ³•                                |
| -------------------- | ----------------------------------- |
| âœ… å¯ä»¥å°è£…          | ç»Ÿä¸€ headerã€è®¤è¯ã€é”™è¯¯å¤„ç†ã€ç±»å‹   |
| âœ… ä¿ç•™ `fetch` è°ƒç”¨ | ä¸è¦ç”¨ axios æ›¿ä»£ï¼ˆæœåŠ¡ç«¯ï¼‰         |
| âœ… æ”¯æŒ `next` é€‰é¡¹  | è®©è°ƒç”¨è€…å¯ä»¥ä¼  `revalidate`ã€`tags` |
| âœ… åˆ†å±‚è®¾è®¡          | `fetch` å·¥å…· â†’ API å°è£… â†’ é¡µé¢ä½¿ç”¨  |
| âœ… æœåŠ¡ç«¯ä¼˜å…ˆ        | å°½é‡åœ¨ Server Components ä¸­å°è£…     |

---

ğŸ¯ **ä¸€å¥è¯å»ºè®®**ï¼š

> **â€œå°è£…çš„æ˜¯ä¾¿åˆ©æ€§ï¼Œä¸æ˜¯æ›¿æ¢ `fetch`â€ â€”â€” ç”¨è½»é‡å°è£…æå‡å¼€å‘æ•ˆç‡ï¼Œä½†ä¿ç•™ Next.js çš„æ ¸å¿ƒä¼˜åŠ¿ã€‚**

å¦‚æœä½ éœ€è¦ï¼Œæˆ‘å¯ä»¥æä¾›ä¸€ä¸ªå®Œæ•´çš„ `lib/api.ts` æ¨¡æ¿ï¼ŒåŒ…å«è®¤è¯ã€é”™è¯¯å¤„ç†ã€ç±»å‹å®šä¹‰ã€æ ‡ç­¾ç®¡ç†ç­‰ ğŸ˜Š

åŠ¨æ€å‡½æ•°ï¼šcookies headers fetch(url, {cache: "no-store"})

- è·¯ç”±é…ç½®
  - dynamic
    - auto
    - force-dynamic
    - error
    - force-static
  - dynamicParams
    - true
    - false
  - revalidate
    - false
    - 0
    - number
  - fetchCache
    - auto
    - force-cache
    - only-cache
    - default-no-store
  - runtime
    - nodejs
    - edge
  - preferredRegion
    - auto
    - home
    - usã€euã€ap
  - maxDuration
  - generateStaticParams

| ä½ çš„éœ€æ±‚               | æ¨èé…ç½®                                            |
| ---------------------- | --------------------------------------------------- |
| å®Œå…¨é™æ€é¡µé¢ï¼ˆå¦‚åšå®¢ï¼‰ | `dynamic = 'force-static'` + `generateStaticParams` |
| å®æ—¶å†…å®¹ï¼ˆå¦‚ä»ªè¡¨ç›˜ï¼‰   | `dynamic = 'force-dynamic'`                         |
| å†…å®¹å¶å°”æ›´æ–°           | `revalidate = 60`                                   |
| å…¨çƒç”¨æˆ·è®¿é—®           | `runtime = 'edge'` + `preferredRegion = 'auto'`     |
| é•¿æ—¶é—´ä»»åŠ¡             | `maxDuration = 60`ï¼ˆVercel Proï¼‰                    |
| å®‰å…¨æ§åˆ¶è·¯ç”±           | `dynamicParams = false`                             |

Google ä¸‰å¤§æ ¸å¿ƒç½‘é¡µæŒ‡æ ‡

- LCP
- INP
- CLS

typescript
mvvc
for await
ios android è¯ä¹¦
vue2 vue3 åŒºåˆ«
es5 å’Œ es6
watch computed

1. è¯·æ±‚è®°å¿†

   React ç»„ä»¶æ ‘å†…æœ‰æ•ˆ(layoutã€ pageã€ generateMetaData)

2. æ•°æ®ç¼“å­˜

- é…ç½®
  ```js
    {cache: ""}ã€ {next: {revalidata: 3500}}
  ```
- æŒ‰éœ€é‡æ–°éªŒè¯

  - åŸºäºæ ‡ç­¾

    ```js
      {next: {tags: ["news"]}}
    ```

  - åŸºäºè·¯å¾„

    ```js
      {next: {revalidata: 3500}}
    ```

3. å®Œæ•´è·¯ç”±ç¼“å­˜

- ä»…é€‚ç”¨äºé™æ€è·¯ç”±

4. è·¯ç”±ç¼“å­˜
